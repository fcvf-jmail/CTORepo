# API для работы со статьями

## Описание

Данный документ описывает RESTful API для управления статьями в системе. API поддерживает полный набор CRUD операций (Create, Read, Update, Delete).

## Endpoints

### 1. Получить статью по ID

**GET** `/api/articles/{id}`

Возвращает статью с указанным идентификатором.

**Параметры:**
- `id` (Guid) - уникальный идентификатор статьи

**Ответы:**
- `200 OK` - статья найдена
- `404 Not Found` - статья не найдена

**Пример успешного ответа:**
```json
{
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "title": "Заголовок статьи",
    "content": "Содержимое статьи",
    "sectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
    "tags": ["тег1", "тег2", "тег3"],
    "createdAt": "2024-11-14T12:00:00Z",
    "updatedAt": "2024-11-14T13:00:00Z"
}
```

### 2. Создать новую статью

**POST** `/api/articles`

Создает новую статью с автоматическим созданием/переиспользованием тегов.

**Тело запроса:**
```json
{
    "title": "Заголовок статьи",
    "content": "Содержимое статьи",
    "sectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
    "tags": ["тег1", "тег2", "тег3"]
}
```

**Валидация:**
- `title` - обязательное поле, от 1 до 256 символов
- `content` - обязательное поле, минимум 1 символ
- `sectionId` - обязательное поле, должен существовать в системе
- `tags` - необязательное поле, список строк

**Особенности обработки тегов:**
- Дедупликация с учетом регистра (case-insensitive)
- Сохранение порядка пользователя
- Переиспользование существующих тегов
- Автоматическое создание новых тегов

**Ответы:**
- `201 Created` - статья создана успешно
- `400 Bad Request` - ошибка валидации или раздел не найден

**Пример успешного ответа:**
```json
{
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "title": "Заголовок статьи",
    "content": "Содержимое статьи",
    "sectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
    "tags": ["тег1", "тег2", "тег3"],
    "createdAt": "2024-11-14T12:00:00Z",
    "updatedAt": null
}
```

### 3. Обновить статью

**PUT** `/api/articles/{id}`

Обновляет существующую статью и ее теги.

**Параметры:**
- `id` (Guid) - уникальный идентификатор статьи

**Тело запроса:**
```json
{
    "title": "Обновленный заголовок",
    "content": "Обновленное содержимое",
    "sectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
    "tags": ["новыйТег1", "новыйТег2"]
}
```

**Валидация:**
- Аналогична созданию статьи

**Особенности:**
- Автоматически устанавливается поле `updatedAt`
- Полностью заменяет список тегов (не объединяет)
- Применяется дедупликация тегов

**Ответы:**
- `200 OK` - статья обновлена успешно
- `404 Not Found` - статья не найдена
- `400 Bad Request` - ошибка валидации или раздел не найден

**Пример успешного ответа:**
```json
{
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "title": "Обновленный заголовок",
    "content": "Обновленное содержимое",
    "sectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
    "tags": ["новыйТег1", "новыйТег2"],
    "createdAt": "2024-11-14T12:00:00Z",
    "updatedAt": "2024-11-14T13:30:00Z"
}
```

### 4. Удалить статью

**DELETE** `/api/articles/{id}`

Удаляет статью из системы.

**Параметры:**
- `id` (Guid) - уникальный идентификатор статьи

**Ответы:**
- `204 No Content` - статья удалена успешно
- `404 Not Found` - статья не найдена

## Автоматические функции

### Временные метки

- При создании статьи автоматически устанавливается `createdAt` (UTC)
- При обновлении статьи автоматически обновляется `updatedAt` (UTC)
- Эти поля управляются на уровне `ApplicationDbContext`

### Обработка тегов

Система применяет следующую логику обработки тегов:

1. **Дедупликация (case-insensitive):**
   - Входные теги: `["тег1", "Тег2", "ТЕГ1", "тег2", "тег3"]`
   - Результат: `["тег1", "Тег2", "тег3"]`

2. **Сохранение порядка пользователя:**
   - Теги сохраняются в том порядке, в котором они были переданы (после дедупликации)

3. **Переиспользование существующих тегов:**
   - Если тег с таким названием (без учета регистра) уже существует, используется существующий
   - Новые теги создаются автоматически

4. **Нормализация:**
   - Все теги хранят `NormalizedName` в нижнем регистре для обеспечения уникальности

## Архитектура решения

### Слои приложения

1. **Presentation Layer** (`WebApi.Presentation`):
   - Эндпоинты API в `ArticleEndpoints.cs`
   - Регистрация сервисов и конфигурация

2. **Application Layer** (`WebApi.Application`):
   - DTOs: `CreateArticleRequest`, `UpdateArticleRequest`, `ArticleResponse`
   - Интерфейс сервиса: `IArticleService`
   - Валидация через Data Annotations

3. **Infrastructure Layer** (`WebApi.Infrastructure`):
   - Реализация сервиса: `ArticleService`
   - Работа с `ApplicationDbContext`
   - Логика обработки тегов

4. **Domain Layer** (`WebApi.Domain`):
   - Сущности: `Article`, `Tag`, `Section`
   - Базовая сущность: `BaseEntity`

### Зависимости

```
Presentation -> Infrastructure -> Application -> Domain
```

## Примеры использования

### Создание статьи с дедупликацией тегов

**Запрос:**
```http
POST /api/articles
Content-Type: application/json

{
    "title": "Введение в C#",
    "content": "C# - это мощный объектно-ориентированный язык программирования...",
    "sectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
    "tags": ["C#", "программирование", "c#", "Программирование", ".NET"]
}
```

**Результат:**
- Теги будут дедуплицированы: `["C#", "программирование", ".NET"]`
- Порядок сохранен согласно первому вхождению

### Обновление статьи со сменой тегов

**Запрос:**
```http
PUT /api/articles/3fa85f64-5717-4562-b3fc-2c963f66afa6
Content-Type: application/json

{
    "title": "Продвинутый C#",
    "content": "Рассмотрим продвинутые возможности C#...",
    "sectionId": "3fa85f64-5717-4562-b3fc-2c963f66afa7",
    "tags": ["C#", "LINQ", "async/await"]
}
```

**Результат:**
- Старые теги будут заменены новыми
- Поле `updatedAt` будет обновлено

## Тестирование

### Unit-тесты

Проект содержит 13 unit-тестов в `WebApi.Tests`:

- Создание статьи с тегами и дедупликацией
- Создание статьи без тегов
- Обновление статьи и проверка `updatedAt`
- Валидация при создании/обновлении
- Получение статьи по ID
- Удаление статьи
- Проверка порядка тегов
- Переиспользование существующих тегов

Запуск тестов:
```bash
dotnet test
```

### HTTP-тесты

Файл с примерами HTTP-запросов: `tests/articles-api.http`

## Известные ограничения

1. Максимальная длина заголовка статьи: 256 символов
2. Максимальная длина названия тега: 256 символов
3. Содержимое статьи не имеет ограничения по длине (TEXT в PostgreSQL)
4. Статья должна принадлежать существующему разделу
