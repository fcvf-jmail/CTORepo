# Каталог разделов (Sections Catalog)

## Обзор

Реализована система автоматического управления разделами на основе тегов статей. Разделы формируются автоматически при создании и обновлении статей, обеспечивая динамическую организацию контента.

## Основные функции

### 1. Автоматическое создание разделов

- Разделы создаются автоматически на основе уникальных наборов тегов
- Порядок тегов не имеет значения (тег1, тег2) === (тег2, тег1)
- Регистр тегов не имеет значения при сопоставлении разделов
- Для статей без тегов создается специальный раздел "Без тегов"

### 2. Автоматический перенос статей

- При изменении тегов статьи автоматически перемещаются в соответствующий раздел
- Если раздел с нужным набором тегов не существует, он создается
- Если раздел уже существует, статья перемещается в него

### 3. Генерация имени раздела

- Имя раздела формируется путем конкатенации отсортированных тегов через запятую
- Теги сортируются по алфавиту (без учета регистра)
- Максимальная длина имени раздела: 1024 символа
- Если имя превышает лимит, оно обрезается

## API Endpoints

### GET /api/sections

Получить список всех разделов с сортировкой по количеству статей (по убыванию).

**Ответ:**
```json
[
  {
    "id": "uuid",
    "name": "тег1, тег2",
    "tags": ["тег1", "тег2"],
    "articleCount": 5,
    "createdAt": "2023-01-01T00:00:00Z",
    "updatedAt": "2023-01-02T00:00:00Z"
  }
]
```

**Особенности:**
- Разделы отсортированы по количеству статей (от большего к меньшему)
- Теги в ответе отсортированы по алфавиту (без учета регистра)
- ArticleCount отражает текущее количество статей в разделе

### GET /api/sections/{sectionId}/articles

Получить список статей в разделе с сортировкой по дате изменения/создания (по убыванию).

**Ответ:**
```json
[
  {
    "id": "uuid",
    "title": "Заголовок статьи",
    "content": "Содержимое",
    "sectionId": "uuid",
    "tags": ["тег1", "тег2"],
    "createdAt": "2023-01-01T00:00:00Z",
    "updatedAt": "2023-01-02T00:00:00Z"
  }
]
```

**Особенности:**
- Статьи отсортированы по дате обновления/создания (новые первыми)
- Если UpdatedAt не null, сортировка по нему, иначе по CreatedAt
- Теги в ответе отсортированы по алфавиту (без учета регистра)

**Ошибки:**
- 404 Not Found - если раздел с указанным ID не существует

## Изменения в API статей

### POST /api/articles и PUT /api/articles/{id}

Поле `sectionId` **удалено** из запросов создания и обновления статей. Раздел теперь определяется автоматически на основе тегов.

**Было:**
```json
{
  "title": "Заголовок",
  "content": "Содержимое",
  "sectionId": "uuid",
  "tags": ["тег1", "тег2"]
}
```

**Стало:**
```json
{
  "title": "Заголовок",
  "content": "Содержимое",
  "tags": ["тег1", "тег2"]
}
```

## Гарантии

### Упорядочивание и дедупликация тегов

- Все списки тегов в ответах возвращаются упорядоченными по алфавиту (case-insensitive)
- Дубликаты тегов автоматически удаляются (case-insensitive сравнение)
- Порядок тегов, указанный пользователем, не сохраняется

### Согласованность данных

- Одинаковые наборы тегов всегда приводят к одному и тому же разделу
- Изменение тегов гарантированно перемещает статью в правильный раздел
- Количество статей в разделах всегда актуально

## Структура базы данных

### Новая таблица SectionTags

```sql
CREATE TABLE "SectionTags" (
    "SectionId" uuid NOT NULL,
    "TagId" uuid NOT NULL,
    CONSTRAINT "PK_SectionTags" PRIMARY KEY ("SectionId", "TagId"),
    CONSTRAINT "FK_SectionTags_Sections_SectionId" FOREIGN KEY ("SectionId") 
        REFERENCES "Sections" ("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_SectionTags_Tags_TagId" FOREIGN KEY ("TagId") 
        REFERENCES "Tags" ("Id") ON DELETE CASCADE
);

CREATE INDEX "IX_SectionTags_TagId" ON "SectionTags" ("TagId");
```

## Архитектура

### Слои приложения

```
ArticleService
    ↓ (использует)
SectionService
    ↓ (работает с)
ApplicationDbContext
```

### Основные компоненты

1. **ISectionService / SectionService**
   - `GetAllAsync()` - получение всех разделов
   - `GetArticlesBySectionIdAsync(sectionId)` - получение статей раздела
   - `GetOrCreateSectionForTagsAsync(tagNames)` - получение/создание раздела для тегов

2. **ArticleService** (обновлен)
   - Теперь зависит от ISectionService
   - Автоматически определяет раздел при создании/обновлении статьи

3. **SectionEndpoints**
   - Регистрация API endpoints для разделов

4. **SectionResponse DTO**
   - Новый DTO для ответов с разделами

## Тесты

Реализованы 12 интеграционных тестов в `SectionServiceTests`:

1. ✅ Автоматическое создание раздела при создании статьи
2. ✅ Автоматический перенос статьи при изменении тегов
3. ✅ Создание раздела "Без тегов" для статей без тегов
4. ✅ Повторное использование существующего раздела
5. ✅ Игнорирование регистра при сопоставлении тегов
6. ✅ Получение разделов с сортировкой по количеству статей
7. ✅ Получение статей раздела с сортировкой по дате
8. ✅ Обработка несуществующего раздела
9. ✅ Возврат упорядоченных тегов в разделах
10. ✅ Обрезка длинных имен разделов до 1024 символов
11. ✅ Возврат упорядоченных тегов в статьях

Все существующие тесты ArticleService (11 тестов) обновлены и проходят успешно.

**Итого: 23 теста проходят успешно ✅**

## Миграции

Создана миграция `AddSectionTagsRelationship`:
- Добавляет таблицу SectionTags для связи many-to-many между разделами и тегами
- Включает индексы для оптимизации запросов
- Настроены каскадные удаления

## Примеры использования

### Создание статьи с автоматическим разделом

```bash
POST /api/articles
{
  "title": "Новая статья",
  "content": "Содержимое статьи",
  "tags": ["программирование", "dotnet", "csharp"]
}

# Автоматически создастся раздел с именем "csharp, dotnet, программирование"
# (теги отсортированы по алфавиту)
```

### Перенос статьи в другой раздел

```bash
PUT /api/articles/{id}
{
  "title": "Обновленная статья",
  "content": "Новое содержимое",
  "tags": ["javascript", "nodejs"]  # Изменились теги
}

# Статья автоматически переместится в раздел "javascript, nodejs"
```

### Получение каталога разделов

```bash
GET /api/sections

# Возвращает разделы, отсортированные по количеству статей
```

### Получение статей раздела

```bash
GET /api/sections/{sectionId}/articles

# Возвращает статьи, отсортированные по дате обновления/создания
```
